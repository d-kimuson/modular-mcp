# Environment Variable Interpolation Support

## User Input
https://github.com/d-kimuson/modular-mcp/issues/8 これ実装しといて。今リモートにいるので要件調整不可でよしなに頼みます

イメージは args とか env で $HOGE って記述があったら環境変数から置換してあげられればOK。これによりファイルをコミットできるようになる

## Acceptance Criteria
- [ ] Environment variables in `args` fields are substituted (e.g., `$HOME` → `/home/user`)
- [ ] Environment variables in `env` fields are substituted
- [ ] Support both `$VAR` and `${VAR}` syntax
- [ ] Configuration files can be safely committed without exposing secrets
- [ ] Existing functionality remains unaffected

## Related Context

### Files to be Modified

**Primary files**:
- `/home/kaito/repos/modular-mcp/src/config/loadConfig.ts` - Configuration loader where env var substitution should be applied
- `/home/kaito/repos/modular-mcp/src/config/schema.ts` - Configuration schema definitions (may need updates for validation)

**Create new utility file**:
- `/home/kaito/repos/modular-mcp/src/utils/envSubstitution.ts` - New utility for environment variable interpolation

**Test file to create**:
- `/home/kaito/repos/modular-mcp/src/utils/envSubstitution.test.ts` - Unit tests for the substitution logic

### Configuration Structure

The configuration is loaded via `/home/kaito/repos/modular-mcp/src/config/loadConfig.ts` and validated against Zod schemas in `/home/kaito/repos/modular-mcp/src/config/schema.ts`.

**Key schema types** (from `/home/kaito/repos/modular-mcp/src/config/schema.ts`):
```typescript
// stdio type server
z.object({
  type: z.literal("stdio").optional().default("stdio"),
  description: z.string(),
  command: z.string(),
  args: z.array(z.string()).optional(),  // <- Needs env var substitution
  env: z.record(z.string(), z.string()).optional(),  // <- Needs env var substitution
})

// http/sse type servers
z.object({
  type: z.literal("http") | z.literal("sse"),
  description: z.string(),
  url: z.string(),
  headers: z.record(z.string(), z.string()).optional(),  // <- May also need substitution
})
```

**Where configs are used**:
- `/home/kaito/repos/modular-mcp/src/proxy/createTransport.ts` line 14-18: Passes `config.command`, `config.args`, `config.env` to StdioClientTransport
- `/home/kaito/repos/modular-mcp/src/server.ts` line 34-56: Connects to MCP servers using the config
- `/home/kaito/repos/modular-mcp/src/proxy/ModularMcpClient.ts`: Uses config to establish connections

**Example config** (`/home/kaito/repos/modular-mcp/config.example.json`):
```json
{
  "mcpServers": {
    "playwright": {
      "description": "Use when you need to control or automate web browsers.",
      "command": "npx",
      "args": ["-y", "@playwright/mcp@latest"],
      "env": {}
    }
  }
}
```

### Tech Stack & Dependencies

**Core dependencies**:
- **Node.js**: >=22.0.0
- **TypeScript**: v5.9.3 with strict type checking (`@tsconfig/strictest`)
- **Zod**: v4.1.12 - Schema validation library (already used extensively)
- **Package Manager**: pnpm v10.20.0+

**Testing setup**:
- **Vitest**: v4.0.7 for unit testing
- Test files use `.test.ts` suffix (see `/home/kaito/repos/modular-mcp/src/auth/lockAuthServer.test.ts`)
- Tests run with `pnpm test` or `pnpm test:watch`
- Config: `/home/kaito/repos/modular-mcp/vitest.config.ts`

**Code quality**:
- Biome for linting/formatting (use `pnpm fix` for auto-fix)
- Double quotes for strings
- Space indentation

### Implementation Constraints

1. **Type Safety**: Must maintain strict TypeScript typing throughout
   - Use proper Zod schemas for validation
   - No `any` types unless absolutely necessary

2. **Backward Compatibility**: Existing configs without env vars must work unchanged
   - Substitution should be transparent
   - No breaking changes to existing functionality

3. **Security Considerations**:
   - Environment variables may contain sensitive data (tokens, API keys)
   - Substitution happens at load time, not stored in config files
   - This enables committing config files without exposing secrets

4. **Supported Syntax**:
   - Both `$VAR` and `${VAR}` syntax
   - Should handle cases where env var doesn't exist (decide on error vs empty string)
   - Consider escaping mechanism (e.g., `$$VAR` → literal `$VAR`)

5. **Where to Apply Substitution**:
   - `args` array elements (strings)
   - `env` object values (strings)
   - `headers` object values (strings) for http/sse
   - Potentially `url` field (needs consideration)
   - `command` field (probably not needed, but consider)

### Existing Similar Patterns

**String processing in codebase**:
- Configuration is parsed as JSON, then validated with Zod
- No existing string interpolation or template processing

**Utilities structure**:
- Utilities live in `/home/kaito/repos/modular-mcp/src/utils/`
- Simple exports with clear function signatures
- Example: `/home/kaito/repos/modular-mcp/src/utils/logger.ts` - simple object with methods

**Testing pattern** (from `/home/kaito/repos/modular-mcp/src/auth/lockAuthServer.test.ts`):
```typescript
import { describe, expect, it } from "vitest";
import { functionToTest } from "./moduleFile.js";

describe("moduleName", () => {
  it("should do something", () => {
    // test implementation
  });
});
```

### Design Considerations

**Substitution timing**: Apply in `loadConfig` after JSON parsing but before or after schema validation?
- **Option A**: After parsing, before validation - allows validation of substituted values
- **Option B**: After validation - simpler but may have type mismatches

**Error handling**:
- Missing env vars: throw error, use empty string, or leave as-is?
- Invalid syntax: throw error or leave as-is?
- Consider logging warnings for debugging

**Recursive vs field-specific**:
- **Recursive approach**: Walk entire config object, substitute all strings
- **Field-specific**: Only substitute known fields (args, env, headers)
- Field-specific is safer and more explicit

**Testing coverage needed**:
- Basic `$VAR` substitution
- `${VAR}` syntax
- Missing environment variables
- Multiple vars in single string
- No substitution needed (backward compat)
- Edge cases: empty strings, special characters

## Design Plan

### 1. Chosen Approach

**Option A: Field-Specific Substitution with Pre-Validation Application**
- Apply substitution to specific known fields (`args`, `env`, `headers`, `url`) after JSON parsing but before Zod validation
- Advantages:
  - Safer and more explicit control over which fields support interpolation
  - Validated values are the actual runtime values (after substitution)
  - Easier to reason about and debug
  - No risk of accidentally interpolating fields that shouldn't be (e.g., `description`, `command`)
- Disadvantages:
  - Requires explicitly listing target fields
  - Slightly more code than recursive approach
- Fit criteria: Best for production code requiring stability and maintainability

**Option B: Recursive Deep Substitution**
- Walk entire config object and substitute all string values
- Advantages:
  - Simpler implementation (single recursive function)
  - Automatically handles new string fields
- Disadvantages:
  - May substitute unintended fields (security/correctness risk)
  - Less explicit about substitution behavior
  - Harder to control which fields support interpolation
- Fit criteria: Suitable for prototypes but risky for production

**Selection: Option A (Field-Specific with Pre-Validation)**

Rationale:
- The requirement explicitly mentions `args` and `env` fields, suggesting targeted substitution
- Production stability is critical - we need explicit control over where interpolation occurs
- The `command` field should NOT be interpolated (security concern - prevents injection attacks)
- The `description` field should NOT be interpolated (it's metadata, not runtime config)
- Pre-validation application ensures Zod validates the actual runtime values

### 2. Implementation Steps

#### Step 1: Create Environment Variable Substitution Utility
**File**: `/home/kaito/repos/modular-mcp/src/utils/envSubstitution.ts`

Create a utility module with:
- Core function `substituteEnvVars(value: string): string` that:
  - Supports both `$VAR` and `${VAR}` syntax
  - Uses `process.env` for lookups
  - Handles missing environment variables (throw error with clear message)
  - Supports multiple variables in a single string (e.g., `$HOME/.config/$APP_NAME`)
- Helper function `substituteInObject(obj: Record<string, string>): Record<string, string>` for object values
- Helper function `substituteInArray(arr: string[]): string[]` for array elements
- Export clear, well-typed interfaces

Error handling strategy:
- Missing env vars throw descriptive error (fail-fast approach - prevents silent failures)
- Include which variable was missing and where it was referenced
- This ensures users are aware when config depends on missing environment setup

#### Step 2: Integrate Substitution into Config Loader
**File**: `/home/kaito/repos/modular-mcp/src/config/loadConfig.ts`

Modify `loadConfig` function to:
- After JSON parsing succeeds (`rawJson.success === true`)
- Before Zod validation (`serverConfigSchema.safeParse`)
- Apply substitution to the parsed JSON object:
  - Iterate through `mcpServers` entries
  - For each server config:
    - If `type === "stdio"`: substitute `args` array and `env` object values
    - If `type === "http"` or `"sse"`: substitute `headers` object values and `url` string
  - Wrap substitution in try-catch to provide clear error messages with server name context

Integration point (lines 41-50 in current implementation):
```typescript
// After: if (!rawJson.success) { throw rawJson.error; }
// Before: const config = serverConfigSchema.safeParse(rawJson.data);
// Insert: Apply environment variable substitution here
```

#### Step 3: Create Comprehensive Unit Tests
**File**: `/home/kaito/repos/modular-mcp/src/utils/envSubstitution.test.ts`

Test coverage:
- Basic substitution: `$HOME` → actual home directory
- Braces syntax: `${HOME}` → actual home directory
- Multiple variables: `$HOME/.config/$APP_NAME` → properly substituted
- Missing environment variables: should throw with clear error message
- No substitution needed: plain strings pass through unchanged
- Empty strings: handle gracefully
- Edge cases:
  - Variable at start, middle, end of string
  - Adjacent variables: `$VAR1$VAR2`
  - Partial matches: `$HOME_DIR` vs `$HOME` (should not partially match)
- Object substitution: all values in record are substituted
- Array substitution: all elements in array are substituted

Setup test environment:
- Use vitest's `beforeEach` to set test environment variables
- Use `afterEach` to clean up test environment variables
- Mock `process.env` for predictable testing

#### Step 4: Add Integration Test (Optional but Recommended)
**File**: `/home/kaito/repos/modular-mcp/src/config/loadConfig.test.ts` (new file)

Test that:
- Loading a config with env vars produces correct substituted values
- Schema validation works on substituted values
- Error messages are clear when substitution fails
- Backward compatibility: configs without env vars work unchanged

#### Step 5: Update Configuration Example
**File**: `/home/kaito/repos/modular-mcp/config.example.json`

Add example demonstrating environment variable usage:
```json
{
  "mcpServers": {
    "playwright": {
      "description": "Use when you need to control or automate web browsers.",
      "command": "npx",
      "args": ["-y", "@playwright/mcp@latest"],
      "env": {}
    },
    "example-with-env-vars": {
      "description": "Example showing environment variable interpolation",
      "command": "node",
      "args": ["$HOME/.local/bin/my-script.js", "--config=${XDG_CONFIG_HOME}/app/config.json"],
      "env": {
        "API_KEY": "$MY_API_KEY",
        "LOG_DIR": "${HOME}/logs"
      }
    }
  }
}
```

### 3. Risks and Mitigation Strategies

#### Risk 1: Missing Environment Variables Breaking Existing Configs
**Impact**: Medium
**Likelihood**: Low

**Scenario**: A config file contains a literal `$` character that looks like a variable reference (e.g., a password like `p$ssword`)

**Mitigation**:
- Document that `$` has special meaning in config values
- Consider supporting escape syntax `$$` → literal `$` (implement if time permits)
- Fail-fast with clear error messages helps users identify issues quickly
- Alternative: Use a different syntax like `#{VAR}` (not recommended - deviates from Unix conventions)

#### Risk 2: Security - Accidental Exposure of Environment Variables
**Impact**: High
**Likelihood**: Low

**Scenario**: Logging or error messages might expose environment variable values

**Mitigation**:
- Substitution happens at load time only
- Substituted values are never logged by the substitution utility
- Error messages should reference variable names, not values
- The config file remains safe to commit (contains `$VAR`, not actual secrets)

#### Risk 3: Platform Differences in Environment Variable Behavior
**Impact**: Low
**Likelihood**: Low

**Scenario**: Environment variable behavior differs between Windows/Linux/macOS

**Mitigation**:
- Node.js `process.env` abstracts platform differences
- Variable names are case-sensitive on all platforms in Node.js
- Document expected behavior in code comments

#### Risk 4: Complex Substitution Patterns Causing Confusion
**Impact**: Medium
**Likelihood**: Medium

**Scenario**: Users might expect advanced features like default values (`${VAR:-default}`) or nested substitution

**Mitigation**:
- Start with simple implementation (`$VAR` and `${VAR}` only)
- Document supported syntax clearly in error messages
- Advanced features can be added in future iterations if needed
- Clear error messages guide users when they use unsupported syntax

#### Risk 5: Breaking Changes to Existing Configurations
**Impact**: High
**Likelihood**: Very Low

**Scenario**: Existing configs with literal `$` characters break after update

**Mitigation**:
- Most configs don't contain `$` characters in values
- If a config has `$` but the variable doesn't exist, clear error is thrown
- Users can immediately identify and fix the issue
- Document breaking change in release notes if `$` character was previously allowed

#### Risk 6: Type Safety Issues with Dynamic Substitution
**Impact**: Low
**Likelihood**: Very Low

**Scenario**: Substitution produces values that don't match Zod schema expectations

**Mitigation**:
- Substitution happens before validation
- Zod validation catches any type mismatches
- Error messages clearly indicate validation failures
- This is actually a feature - ensures runtime values are valid

### 4. Design Constraints and Assumptions

**Constraints**:
1. Must maintain strict TypeScript type safety throughout implementation
2. Must maintain 100% backward compatibility with existing configs
3. Must use existing tooling (Zod for validation, Vitest for testing)
4. Must follow project code style (Biome configuration, double quotes, etc.)
5. Cannot introduce new runtime dependencies

**Assumptions**:
1. Environment variables are set before the application starts
2. Environment variable values are strings (Node.js standard)
3. Config files are loaded once at startup (substitution happens once)
4. The `command` field should NOT support interpolation (security)
5. The `description` field should NOT support interpolation (not runtime config)
6. Missing environment variables are configuration errors (fail-fast)
7. Users understand Unix-style environment variable syntax
8. The primary use case is to avoid committing secrets to version control

**Context for Implementers**:
- The substitution logic must be pure and testable without file I/O
- Error messages should include context (which server, which field) for debugging
- The implementation should be simple and maintainable - avoid over-engineering
- Focus on the 80% use case first (simple `$VAR` substitution)
- The utility should be reusable if other parts of the system need env var substitution in future

## Fixes
<!-- Populated by reviewer or pr-checker -->

## Memo
Task ID: 56623189-6267-4786-b8d9-09b6b4bd4732

### Implementation Session List
- Session 1: Create environment variable substitution utility and unit tests ✅ COMPLETED
- Session 2: Integrate substitution into config loader
- Session 3: Update configuration example

### Session 1 Completion Notes
- Created `/home/kaito/repos/modular-mcp/src/utils/envSubstitution.ts` with core substitution logic
- Created `/home/kaito/repos/modular-mcp/src/utils/envSubstitution.test.ts` with 28 passing tests
- All tests pass, zero type errors, zero lint errors
- Committed: 72bf154a3051259c1fd5de72e640c32ee20655df
- No additional session candidates discovered
